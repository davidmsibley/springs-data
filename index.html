<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Springs Data</title>
  <base href="/springs-data/">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <!-- Caroline Rose | cmrrose.github.com | March 2019 | Wisconsin Geological and Natural History Survey-->
  <script>
    (function(){
      var redirect = sessionStorage.redirect;
      delete sessionStorage.redirect;
      if (redirect && redirect != location.href) {
        history.replaceState(null, null, redirect);
      }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/navigo@^7/lib/navigo.js"></script>
  
  <!-- Load Leaflet from a CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@^1/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@^1/dist/leaflet.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/esri-leaflet@^2/dist/esri-leaflet.js"></script>
    
  <!--load D3 --> 
  <script src="https://d3js.org/d3.v5.js"></script>  

  <!-- Load Web Component base -->
  <script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.2.10/webcomponents-loader.js"></script>
  <script src="js/common.min.js"></script>

  <link rel="stylesheet" href="css/reset.css" />
  <link rel="stylesheet" href="css/variables.css" />
  <link rel="stylesheet" href="css/typography.css" />

  <style>
    @media (min-width: 770px) {
      [data-view=app] {
        display: grid;
        grid-template-columns: 50% 50%;
      }
      app-sidebar {
        overflow-y: auto;
      }
    }
    @media (max-width: 769px) {
      [data-view=app] {
        display: grid;
        grid-template-rows: 80% 100%;
        overflow-y: auto;
      }
      #map {
        grid-row-start: 1;
      }
    }
    [data-view] {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }
    [data-closed] {
      display: none;
    }
  </style>
  <script src="./lit/index.js"></script>
</head>
<body>
  <div data-view="app">
    <app-sidebar id="sidebar">
      <section>
        <h2>
          Select a spring to learn more!
        </h2>
        <p>
          Lorem ipsum dolor sit amet, viris efficiendi suscipiantur 
          quo eu, eam altera iudicabit eu. Eu per molestie antiopam, 
          eam in nemore iracundia, cum ei audiam iuvaret. Sed an erat 
          sonet dolor, option lucilius sed cu, qui sadipscing 
          comprehensam te. Magna recusabo intellegebat mei in. Purto 
          rebum tibique no qui, enim minim eleifend ut pro.
        </p>
      </section>
      <div slot="details">
        <site-details></site-details>
      </div>
    </app-sidebar>
    <div id="map"></div>
  </div>
  <div data-view="print" data-closed>
    <site-details></site-details>
  </div>
  <script>
    /* JAVASCRIPT */
    
      /* ~~~~~~~~ Map ~~~~~~~~ */
    //create a map, center it, and set the zoom level. 
    //set zoomcontrol to false because we will add it in a different corner. 
    var map = L.map('map', {zoomControl:false}).setView([45, -89.623861], 6);

    /* ~~~~~~~~ Map Layers ~~~~~~~~ */
    //basemap from Open Street Map
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    /* ~~~~~~~~ Zoom Control ~~~~~~~~ */
    //place a zoom control in the top right: 
    new L.Control.Zoom({position: 'topright'}).addTo(map);

    /* +++++++++++ Springs layer +++++++++++ */ 
    var springs = L.esri.featureLayer({
        url: "https://data.wgnhs.wisc.edu/arcgis/rest/services/springs/springs_inventory/MapServer/1",
    }).addTo(map);

    var springPhotos = L.esri.featureLayer({
      url: "https://data.wgnhs.wisc.edu/arcgis/rest/services/springs/springs_inventory/MapServer/6"
    });

    var popupTemplate = "<h3>{County} County Spring #{SpringID}</h3>";

    springs.bindPopup(function(e){
        return L.Util.template(popupTemplate, e.feature.properties); 
    });

    var selectFeature = function(info) {
      var sidebar = document.querySelector('#sidebar');
      var details = document.querySelectorAll('site-details');

      details.forEach(function(el) {
        el['siteinfo'] = null;
        el['photos'] = null;
      });

      springPhotos.query().where("Site_Code = '" + info['Site_Code'] + "'").run(function(err, col) {
        if (!err) {
          var photos = col.features.map( function(value, index) { return value.properties; } );
          photos.sort(function(a, b) {
            return a.Image_Number - b.Image_Number;
          });

          details.forEach(function(el) {
            el['siteinfo'] = info;
            el['photos'] = photos;
          });
          sidebar.switchTab('details');
        } else {
          console.log('Could not get Spring Photos', err);
        }
      });
    };

    var deselectFeature = function() {
      var sidebar = document.querySelector('#sidebar');
      var details = document.querySelectorAll('site-details');

      details.forEach(function(el) {
        el['siteinfo'] = null;
        el['photos'] = null;
      });
      sidebar.switchTab('default');
    }

    springs.on('popupopen', function(e) {
      var info = e.propagatedFrom.feature.properties;
      router.pause()
      router.navigate(router.generate('view.site', {siteCode: info['Site_Code']}));
      router.resume();
      selectFeature(info);
    });

    springs.on('popupclose', function(e) {
      router.navigate('/');
      deselectFeature();
    });

    var router = new Navigo(window.location.origin + '/springs-data/');
    router.on({
      '/view/:siteCode': {
        as: 'view.site',
        uses: function(params) {
          springs.on('load', function() {
            springs.eachFeature(function(obj, l) {
              if (obj.feature.properties['Site_Code'] === params['siteCode']) {
                obj.getElement().click();
              }
            });
          });
        }
      }
    })
    .notFound(function() {
    })
    .resolve();
  </script>
</body>
</html>
